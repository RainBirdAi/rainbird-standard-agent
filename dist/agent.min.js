function resourceErrorHandler(r){console.log("Resource Error"),console.log(r)}var services=angular.module("rbApp.tryGoal.service",["ngResource"]);services.factory("ConfigAPI",["$resource",function(r){return r("",{},{config:{method:"GET",url:"/agent/:id/config",interceptor:{responseError:resourceErrorHandler}},getGoalInfo:{method:"GET",url:"/goal/info/:goalid/:id",interceptor:{responseError:resourceErrorHandler}},getSessionId:{method:"GET",url:"/agent/:id/start/contextid",interceptor:{responseError:resourceErrorHandler}}})}]),services.factory("agentHttpInterceptor",["agentMemory","$rootScope",function(r,e){return e.apiOutput=new Array,{request:function(o){if(r.tryGoal&&!o.url.endsWith(".html")&&(o.url.endsWith("query")||o.url.endsWith("response"))){var t={type:"request"};t.method=o.method,t.url=o.url,t.params=o.params,t.data=o.data,t.headers=o.headers,e.apiOutput.push(t)}return o},response:function(o){var t;return o.data&&o.data.apiLog?(t=o.data.apiLog,e.apiOutput.push(t.request),e.apiOutput.push(t.response)):r.tryGoal&&!o.config.url.endsWith(".html")&&(o.config.url.endsWith("query")||o.config.url.endsWith("response"))&&(t={type:"response"},t.method=o.config.method,t.url=o.config.url,t.data=o.data,t.headers=o.config.headers,e.apiOutput.push(t)),o}}}]),services.factory("GoalAPI",["$resource","ApiConfig",function(r,e){return r("",{sessionId:"@sessionId"},{startGoal:{method:"GET",url:e.getConfig().url+"/start/:id",interceptor:{responseError:resourceErrorHandler},headers:{Authorization:e.getConfig().auth}},queryGoal:{method:"POST",url:e.getConfig().url+"/:sessionId/query",interceptor:{responseError:resourceErrorHandler}},response:{method:"POST",url:e.getConfig().url+"/:sessionId/response",interceptor:{responseError:resourceErrorHandler}},back:{method:"POST",url:e.getConfig().url+"/:sessionId/undo",interceptor:{responseError:resourceErrorHandler}}})}]);
angular.module("rbApp.tryGoal",["rbApp.tryGoal.service","ng-showdown"]).config(["$showdownProvider",function(e){e.setOption("omitExtraWLInCodeBlocks",!0),e.setOption("literalMidWordUnderscores",!0),e.setOption("strikethrough",!0),e.setOption("tables",!0),e.setOption("ghCodeBlocks",!0),e.setOption("tasklists",!0),e.setOption("disableForced4SpacesIndentedSublists",!0),e.setOption("simpleLineBreaks",!0),e.setOption("noHeaderId",!0),e.setOption("parseImgDimensions",!0),e.setOption("openLinksInNewWindow",!0)}]);
var agentApp=angular.module("rbAgent",["ui.router","rbApp.tryGoal","rbApp.tryGoal.service","ui.bootstrap"]);agentApp.value("agentMemory",{contextId:"",sessionId:"",tryGoal:!1}),agentApp.config(["$stateProvider","$urlRouterProvider","$httpProvider",function(t,r,e){r.otherwise("/main"),t.state("unauthorised",{url:"/unauthorised"}).state("main",{url:"/main",templateUrl:"/applications/main.html",controller:"MainController",resolve:{config:["ConfigAPI","$rootScope",function(t,r){return t.config({id:r.id})}]}}).state("main.goalList",{url:"/goalList",templateUrl:"/applications/goalList/agentGoalList.html",controller:"AgentGoalListController",resolve:{config:["$q","ConfigAPI","$rootScope","Security","$state",function(t,r,e,o,n){var i=t.defer();return r.config({id:e.id}).$promise.then(function(t){e.config=t,o.checkReferrerValid(t.authorisedDomains)?i.resolve(t):(n.go("unauthorised"),i.reject())}),i.promise}]}}).state("main.startGoal",{url:"/startGoal",templateUrl:"/applications/tryGoal/component/tryGoalAgent.html",controller:"TryGoalController",resolve:{config:["ConfigAPI","$rootScope",function(t,r){return t.config({id:r.id})}]},params:{goalInfo:null,id:null}}),e.interceptors.push("agentHttpInterceptor")}]),agentApp.service("ApiConfig",["$rootScope",function(t){var r={url:t.api};return{getConfig:function(){return r}}}]),agentApp.factory("focusElementById",["$timeout","$window",function(t,r){return function(e){t(function(){var t=r.document.getElementById(e);t&&t.focus()})}}]),agentApp.factory("Security",["$window","formatHelpers",function(t,r){return{checkReferrerValid:function(e){var o=!0;if(t.self!=t.top){var n=t.document.referrer;if(Array.isArray(e)&&e.length>0&&n){var i=r.formatAuthorisedDomain(e),a=r.extractSchemeAndHost(n),c=i.indexOf(a);-1===c&&(o=!1)}}return o}}}]),agentApp.factory("formatHelpers",function(){var t={};return t.extractSchemeAndHost=function(t){var r=t.match(/(^https?\:\/\/([^\/?#]+))(?:[\/?#]|$)/i);return r&&r[1]},t.formatAuthorisedDomain=function(r){var e=[];return r.forEach(function(r){e.push(t.extractSchemeAndHost(r))}),e},t}),agentApp.directive("autofocus",["$timeout",function(t){return{restrict:"A",link:function(r,e){t(function(){e[0].focus()},500)}}}]);
angular.module("rbApp.tryGoal").controller("TryGoalController",["$scope","agentMemory","$compile","$stateParams","config","GoalAPI","ConfigAPI","ApiConfig","$state","$location","$filter","focusElementById","$timeout","$rootScope",function(e,n,t,o,s,r,a,i,u,l,c,p,d,f){function g(n){e.errorMessage=n&&n.message?n.message:"Unfortunately Rainbird has been unable to process the goal against the current Knowledge Map.",e.display="error"}function h(e,n){return'<input id="numberInput'+n+'" class="rb-try-goal-full-width numberInput" rb-number-only type="number" ng-model="response.questions['+e+"].answer.selection["+n+']" class="rb_input number" />'}function b(e,n){return'<div class="instanceDatepicker" id="dateInput'+n+'"><input id="dateInputText'+n+'" type="text" class="form-control" uib-datepicker-popup ng-model="response.questions['+e+"].answer.selection["+n+']" is-open="datePicker.instances['+n+']" datepicker-options="datePicker.options" ng-required="true" close-text="Close" show-button-bar="false" placeholder="yyyy-MM-dd" popup-placement="auto bottom-left" ng-model-options="{timezone: \'utc\'}"/>  <button id="datePicker'+n+'" type="button" class="btn btn-default displayPicker" ng-click="datePicker.open($event, '+n+')"><i class="glyphicon glyphicon-calendar"></i></button></div>'}function y(e){"date"===e.question.objectType&&(e.question.prompt=e.question.prompt.replace(e.question.object,c("rbDateOutputFormat")(e.question.object)))}function I(n){return n&&n.prompt===e.response.question.prompt&&n.type===e.response.question.type}function m(){null!=o.goalInfo?(e.display="thinking",e.goalInfo=o.goalInfo,e.runGoal(e.goalInfo)):u.go("main.goalList",null,{location:"replace"})}function w(){o.hasOwnProperty("goalInfo")&&m()}var j,q;e.config=s,e.otherOption={value:"(other - not listed)"},e.yolandaUrl=i.getConfig().url,e.tryGoal=n.tryGoal,e.splitScreen=!1,e.updateAlias=function(){q=null},e.$on("tryGoal",function(n,t){$("#tryGoalModal").modal("show"),e.display="thinking",a.getGoalInfo({goalid:t.goalid,id:o.id},function(n){e.goalInfo=n,e.runGoal(n)})}),e.getGoalInfo=function(n){e.display="thinking",a.getGoalInfo({goalid:n,id:o.id},function(n){e.goalInfo=n,e.runGoal(n)})},e.postMessage=function(e){parent.postMessage(e,"*")},e.runGoal=function(n){var t=!1;e.init={},f.apiOutput=new Array,j=n.contextId,"user provided"===n.objectInstance?(e.objectPrompt=n.object,e.subjectPrompt=null,t=!0):"user provided"===n.subjectInstance?(e.subjectPrompt=n.subject,e.objectPrompt=null,t=!0):(e.init.subjectInstance=n.subjectInstance,e.init.objectInstance=n.objectInstance),t?e.display="init data":e.startGoalContext()},e.addPluralInput=function(n,o){var s=e.response.questions[n].pluralInputCounter++,r=angular.element("number"==o?h(n,s):b(n,s)),a=document.querySelector("#"+o+"Inputs"+n);t(r)(e),angular.element(a).append(r)},e.$watch("apiOutput",function(){if(n.tryGoal){var e=JSON.stringify(f.apiOutput,null,1),t=e.split("\n");t.splice(0,1),t.length>0&&t.splice(t.length-1,1),f.apiOutputDisplay=t.join("\n")}d(function(){var e=document.querySelector("#scroll-content");e.scrollTop=e.scrollHeight},150)},!0),e.removePluralInput=function(n,t){var o=document.querySelector("#"+t+"Inputs"+n+" #"+t+"Input"+(e.response.questions[n].pluralInputCounter-1));o.parentNode.removeChild(o),delete e.answer.selection[e.response.questions[n].pluralInputCounter-1],e.response.questions[n].pluralInputCounter--},e.startGoalContext=function(){e.display="thinking",a.getSessionId({id:o.id,contextid:j},function(n){q=n.sessionId,e.queryGoal()})},e.queryGoal=function(){var n={id:o.id,sessionId:q,object:"user provided"==e.goalInfo.objectInstance?e.init.objectInstance:e.goalInfo.objectInstance,subject:"user provided"==e.goalInfo.subjectInstance?e.init.subjectInstance:e.goalInfo.subjectInstance,relationship:e.goalInfo.relationship?e.goalInfo.relationship:e.goalInfo.rel};e.postMessage(n),r.queryGoal(n,function(n){e.showError=!1,e.processResponse(n)},function(e){g(e.data)})},e.processResponse=function(n){e.postMessage(n),n.question&&n.question.allowUnknown&&p("mainAgent"),n.questions=[],n.question&&(s.uiSettings.questionGrouping&&n.extraQuestions&&(n.questions=n.extraQuestions),n.questions.splice(0,0,n.question),n.questions.forEach(function(n){n.answer={selection:[],cf:100},n.pluralInputCounter=1,n.concepts&&n.concepts.length>0&&n.canAdd!==!1&&e.unidirectionalPluralFalse(n)&&n.concepts.push(e.otherOption)}),e.response=n),n.question?"First Form"===n.question.type?(e.display="firstForm",y(n)):e.display="secondForm":n.result&&angular.isArray(n.result)&&n.result.length>0?(e.goalResults=[],e.response={},n.result.forEach(function(n){var t=e.goalInfo.goalText?e.goalInfo.goalText:e.goalInfo.text,o=n.objectMetadata?n.objectMetadata:"";t=t.replace(/%O/g,n.object),t=t.replace(/%R/g,n.relationship),t=t.replace(/%S/g,n.subject),t=t.replace(/%C/g,n.certainty),e.goalResults.push(e.config.showEvidence?{text:t,cf:n.certainty,meta:o,factID:n.factID}:{text:t,cf:n.certainty,meta:o})}),e.display="result",p(e.tryGoal?"reset":"done")):angular.isArray(n.result)?e.display="end":g(n)},e.addOtherInput=function(n){if(!e.unidirectionalPluralFalse(e.response.questions[n])){var o=document.querySelectorAll("#question"+n+" .otherInput"),s=0;if(o.forEach(function(e){e.value||s++}),!s){var r=e.response.questions[n].concepts?e.response.questions[n].concepts.length:0,a=r+e.response.questions[n].pluralInputCounter,i=angular.element('<div class="inlineCheckboxGrouped" id="otherValueInput'+a+'"><label><i class="fa fa-minus-square" aria-hidden="true" ng-click="removeOtherInput('+n+", "+a+');"></i><input id="pluralOther0" ng-model="response.questions['+n+"].answer.selection["+a+']" ng-change="addOtherInput('+n+')" placeholder="enter other value" class="otherInput rb-try-goal-full-width"value="" type="text"></label></div>');t(i)(e);var u=document.querySelector("#question"+n+" #secondFormBlock");angular.element(u).append(i),e.response.questions[n].pluralInputCounter++}}},e.removeOtherInput=function(n,t){delete e.response.questions[n].answer.selection[t];var o=document.querySelectorAll("#question"+n+" .otherInput"),s=0;o.forEach(function(e){e.value||s++});for(var r=0;r<o.length;r++)if(!o[r].value){o.length>1&&s>1&&(s--,angular.element(document.querySelector("#question"+n+" #otherValueInput"+t)).remove());break}},e.enterPressed=function(){"init data"===e.display?(e.init.objectInstance||e.init.subjectInstance)&&e.startGoalContext():e.disableContinue()||e.respond()},e.selectConcept=function(e,n,t){t.answer.selection[n]===e||""===e?delete t.answer.selection[n]:t.answer.selection[n]=e},e.respond=function(){var n=function(e,n){return"date"==e?n.getTime?n.getTime():new Date(n).getTime():"truth"==e?"yes"==n:n},t=function(e){return 0==e||0==e||e};e.display="thinking";var s=[];e.response.questions.forEach(function(o){if("First Form"==o.type){var r={subject:o.subject,object:o.object,relationship:o.relationship,cf:o.answer.cf};o.answer.selection.length?r.answer=o.answer.selection[0]:r.unanswered=!0,s.push(r)}else o.answer.selection.length?o.answer.selection.forEach(function(r){t(r)&&(r==e.otherOption.value&&(r=o.answer.otherValue),s.push({subject:"Second Form Subject"==o.type?r:o.subject,object:"Second Form Object"==o.type?n(o.dataType,r):o.object,relationship:o.relationship,cf:o.answer.cf}))}):0==o.knownAnswers.length&&s.push({subject:"Second Form Subject"==o.type?"":o.subject,object:"Second Form Object"==o.type?"":o.object,relationship:o.relationship,cf:o.answer.cf,unanswered:!0});o.knownAnswers&&o.knownAnswers.forEach(function(e){s.push({subject:e.subject,object:e.object,relationship:e.relationship.name,cf:e.cf})})}),e.postMessage({id:o.id,sessionId:q,answers:s}),r.response({id:o.id,sessionId:q,answers:s},function(n){e.processResponse(n)},function(e){g(e.data)})},e.back=function(){e.display="thinking",r.back({sessionId:q},function(n){I(n.question)?e.runGoal(e.goalInfo):e.processResponse(n)},function(e){g(e.data)})},e.done=function(){e.postMessage("Done"),$("#tryGoalModal").modal("hide")},e.datePicker=function(){var e={};return e.instances=[],e.open=function(n,t){n.preventDefault(),n.stopPropagation(),e.instances[t]=!e.instances[t]},e.options={startingDay:1,showWeeks:!1},e}(),e.exit=function(){e.postMessage("Reset"),u.go("main.goalList",null,{location:"replace"})},e.conceptIsKnownAnswer=function(n){var t=!1;return e.response.question.knownAnswers.forEach(function(o){(n===o.subject&&"Second Form Subject"===e.response.question.type||n===o.object&&"Second Form Object"===e.response.question.type)&&(t=!0)}),t},e.displayContinueOrSkip=function(){var n=!0;return e.response.questions.forEach(function(t){(!t.allowUnknown||t.knownAnswers&&t.knownAnswers.length>0||e.containsAnswer(t.answer.selection))&&(n=!1)}),n?"Skip":"Continue"},e.disableContinue=function(){var n=!1;return e.response.questions.forEach(function(t){n||t.allowUnknown||!(t.knownAnswers&&0==t.knownAnswers.length||void 0==t.knownAnswers)||e.containsAnswer(t.answer.selection)||(n=!0)}),n},e.containsAnswer=function(n){for(var t=!1,o=0;o<n.length;o++)e.hasValue(n[o])&&(t=!0);return t},e.hasValue=function(e){return""!==e&&void 0!==e},e.unidirectionalPluralFalse=function(n){return e.unidirectionalPluralFalseEnabled?!n.plural&&n.subject:!n.plural},w()}]);
angular.module("rbAgent").controller("AgentGoalListController",["agentMemory","$scope","$rootScope","config","$state",function(o,e,n,t,a){function l(o,e,n){console.log("------- Rainbird Agent -------"),console.log("Agent ID   :",o),console.log("Endpoint   :",e),console.log("User       :",n.kbUser),console.log("Goals      :",n.goals.length),console.log("Evidence   :",n.showEvidence?"enabled":"disabled"),console.log("Context    :",n.showAlias?"enabled":"disabled"),console.log("UI-Settings:",n.uiSettings),console.log("------------------------------")}function s(o){e.errorMessage=o.message?o.message:"Sorry! An error occurred. Please try again.",e.display="error"}e.config=t,e.contextId=o.contextId,e.tryGoal=!1,window.addEventListener("message",function(n){n.data&&n.data.tryGoal&&(o.tryGoal=!0,n.data.close?a.go("main.goalList",null,{location:"replace"}):(parent.postMessage("goal received","*"),a.go("main.startGoal",{goalInfo:n.data,id:e.id},{location:"replace"})))},!1),void 0===t.$resolved||t.$resolved?l(e.id,e.api,t):t.$promise.then(function(){l(e.id,e.api,t)}).catch(function(o){s(o.data)}),e.startGoal=function(n){parent.postMessage({goal:n},"*"),n.contextId=e.contextId,o.contextId=n.contextId,a.go("main.startGoal",{goalInfo:n,id:e.id})}}]);
angular.module("rbAgent").controller("MainController",["$scope","config","$state",function(o,n,l){o.config=n,o.state=l,l.go("main.goalList",null,{location:"replace"})}]);