function resourceErrorHandler(r){console.log("Resource Error"),console.log(r)}var services=angular.module("rbApp.tryGoal.service",["ngResource"]);services.factory("ConfigAPI",["$resource",function(r){return r("",{},{config:{method:"GET",url:"/agent/:id/config",interceptor:{responseError:resourceErrorHandler}},getGoalInfo:{method:"GET",url:"/goal/info/:goalid/:id",interceptor:{responseError:resourceErrorHandler}},getSessionId:{method:"GET",url:"/agent/:id/start/contextid",interceptor:{responseError:resourceErrorHandler}}})}]),services.factory("GoalAPI",["$resource","ApiConfig",function(r,e){return r("",{sessionId:"@sessionId"},{startGoal:{method:"GET",url:e.getConfig().url+"/start/:id",interceptor:{responseError:resourceErrorHandler},headers:{Authorization:e.getConfig().auth}},queryGoal:{method:"POST",url:e.getConfig().url+"/:sessionId/query",interceptor:{responseError:resourceErrorHandler}},response:{method:"POST",url:e.getConfig().url+"/:sessionId/response",interceptor:{responseError:resourceErrorHandler}}})}]);
angular.module("rbApp.tryGoal",["rbApp.tryGoal.service","ng-showdown"]).config(["$showdownProvider",function(e){e.setOption("omitExtraWLInCodeBlocks",!0),e.setOption("literalMidWordUnderscores",!0),e.setOption("strikethrough",!0),e.setOption("tables",!0),e.setOption("ghCodeBlocks",!0),e.setOption("tasklists",!0),e.setOption("disableForced4SpacesIndentedSublists",!0),e.setOption("simpleLineBreaks",!0),e.setOption("noHeaderId",!0),e.setOption("parseImgDimensions",!0)}]);
var agentApp=angular.module("rbAgent",["ui.router","rbApp.tryGoal","rbApp.tryGoal.service","ui.bootstrap"]);agentApp.value("agentMemory",{contextId:"",sessionId:""}),agentApp.config(["$stateProvider","$urlRouterProvider",function(o,t){t.otherwise("/"),o.state("goalList",{url:"/",templateUrl:"/goalList/agentGoalList.html",controller:"AgentGoalListController",resolve:{config:["ConfigAPI","$rootScope",function(o,t){return o.config({id:t.id})}]}}).state("startGoal",{url:"/startGoal",templateUrl:"/tryGoal/component/tryGoalAgent.html",controller:"TryGoalController",resolve:{config:["ConfigAPI","$rootScope",function(o,t){return o.config({id:t.id})}]},params:{goalInfo:null,id:null}})}]),agentApp.service("ApiConfig",["$rootScope",function(o){var t={url:o.api};return{getConfig:function(){return t}}}]);
angular.module("rbApp.tryGoal").controller("TryGoalController",["$scope","$compile","$stateParams","config","GoalAPI","ConfigAPI","ApiConfig","$state","$location","$filter",function(e,n,t,o,s,a,r,i,l,u){function c(n){e.errorMessage=n&&n.message?n.message:"Unfortunately Rainbird has been unable to process the goal against the current Knowledge Map.",e.display="error"}function p(e){return'<input id="numberInput'+e+'" class="rb-try-goal-full-width numberInput" rb-number-only type="number" ng-model="answer.selection['+e+']" class="rb_input number" />'}function d(e){return'<div class="instanceDatepicker" id="dateInput'+e+'"><input id="dateInputText'+e+'" type="text" class="form-control" uib-datepicker-popup ng-model="answer.selection['+e+']" is-open="datePicker.instances['+e+']" datepicker-options="datePicker.options" ng-required="true" close-text="Close" show-button-bar="false" placeholder="yyyy-MM-dd" popup-placement="auto bottom-left" ng-model-options="{timezone: \'utc\'}"/>  <button id="datePicker'+e+'" type="button" class="btn btn-default displayPicker" ng-click="datePicker.open($event, '+e+')"><i class="glyphicon glyphicon-calendar"></i></button></div>'}function f(e){"date"===e.question.objectType&&(e.question.prompt=e.question.prompt.replace(e.question.object,u("rbDateOutputFormat")(e.question.object)))}function g(e){for(var n=0;n<e.length;n++)if(h(e[n]))return!0;return!1}function h(e){return e||0===e||e===!1}function b(){null!=t.goalInfo?(e.display="thinking",e.goalInfo=t.goalInfo,e.runGoal(e.goalInfo)):i.go("goalList")}function y(){t.hasOwnProperty("goalInfo")&&b()}var I,m;e.config=o,e.otherOption={value:"(other - not listed)"},e.yolandaUrl=r.getConfig().url,e.updateAlias=function(){m=null},e.$on("tryGoal",function(n,o){$("#tryGoalModal").modal("show"),e.display="thinking",a.getGoalInfo({goalid:o.goalid,id:t.id},function(n){e.goalInfo=n,e.runGoal(n)})}),e.postMessage=function(e){parent.postMessage(e,"*")},e.runGoal=function(n){var t=!1;e.init={},I=n.contextId,"user provided"===n.objectInstance?(e.objectPrompt=n.object,e.subjectPrompt=null,t=!0):"user provided"===n.subjectInstance?(e.subjectPrompt=n.subject,e.objectPrompt=null,t=!0):(e.init.subjectInstance=n.subjectInstance,e.init.objectInstance=n.objectInstance),t?e.display="init data":e.startGoalContext()},e.addPluralInput=function(t){var o=e.pluralInputCounter++,s=angular.element("number"==t?p(o):d(o)),a=document.querySelector("#"+t+"Inputs");n(s)(e),angular.element(a).append(s)},e.removePluralInput=function(n){var t=document.querySelector("#"+n+"Input"+(e.pluralInputCounter-1));t.parentNode.removeChild(t),delete e.answer.selection[e.pluralInputCounter-1],e.pluralInputCounter--},e.startGoalContext=function(){e.display="thinking",-1==l.absUrl().indexOf("agent")?s.startGoal({id:t.id,contextid:I},function(n){m=n.id,e.queryGoal()},function(e){c(e.data)}):a.getSessionId({id:t.id,contextid:I},function(n){m=n.sessionId,e.queryGoal()})},e.queryGoal=function(){var n={id:t.id,sessionId:m,object:"user provided"==e.goalInfo.objectInstance?e.init.objectInstance:e.goalInfo.objectInstance,subject:"user provided"==e.goalInfo.subjectInstance?e.init.subjectInstance:e.goalInfo.subjectInstance,relationship:e.goalInfo.relationship?e.goalInfo.relationship:e.goalInfo.rel};e.postMessage(n),s.queryGoal(n,function(n){e.showError=!1,e.processResponse(n)},function(e){c(e.data)})},e.processResponse=function(n){e.postMessage(n),e.answer={cf:100,selection:[]},e.otherValues=[],e.response=n,n.question?(n.question.plural&&(e.pluralInputCounter=1,e.answer.selection=[]),"First Form"===n.question.type?(e.display="firstForm",f(n)):(e.response.concepts=n.question.concepts,e.response.concepts&&n.question.canAdd!==!1&&!e.response.question.plural&&e.response.concepts.push(e.otherOption),e.display="secondForm")):n.result&&angular.isArray(n.result)&&n.result.length>0?(e.goalResults=[],n.result.forEach(function(n){var t=e.goalInfo.goalText?e.goalInfo.goalText:e.goalInfo.text,o=n.objectMetadata?n.objectMetadata:"";t=t.replace("%O",n.object),t=t.replace("%R",n.relationship),t=t.replace("%S",n.subject),e.goalResults.push(e.config.showEvidence?{text:t,cf:n.certainty,meta:o,factID:n.factID}:{text:t,cf:n.certainty,meta:o})}),e.display="result"):angular.isArray(n.result)?e.display="end":c(n)},e.addOtherInput=function(){if(e.response.question.plural&&!~e.otherValues.indexOf("")){var t=e.otherValues.length,o=e.response.question.concepts?e.response.question.concepts.length:0;e.otherValues[t]="";var s=angular.element('<div class="inlineCheckboxGrouped" id="otherValueInput'+t+'"><label><i class="fa fa-minus-square" aria-hidden="true" ng-click="selectConcept(otherValues['+t+"], "+(t+o)+"); removeOtherInput("+t+')"></i><input ng-model="otherValues['+t+']" class="rb-try-goal-full-width"  placeholder="enter other value" ng-change="selectConcept(otherValues['+t+"], "+(t+o)+"); addOtherInput(["+t+'])"    value="" type="text" style="margin-left: 3px;"></label></div>');n(s)(e);var a=document.querySelector("#secondFormBlock");angular.element(a).append(s)}},e.removeOtherInput=function(n){void 0!==n&&(e.otherValues[n]="");for(var t=e.otherValues.indexOf(""),o=Object.keys(e.otherValues),s=o.length-1;s>=0;s--)void 0!=e.otherValues[o[s]]&&""!==e.otherValues[o[s]]||o[s]==t||(angular.element("#otherValueInput"+o[s]).remove(),delete e.otherValues[o[s]])},e.enterPressed=function(){"init data"===e.display?e.startGoalContext():e.disableContinue()||e.respond()},e.selectConcept=function(n,t){e.answer.selection[t]===n||""===n?delete e.answer.selection[t]:e.answer.selection[t]=n,e.removeOtherInput()},e.respond=function(){var n,o={subject:e.response.question.subject,relationship:e.response.question.relationship,object:e.response.question.object,cf:e.answer.cf},a=[],r=[];if(e.display="thinking",e.answer.selection&&(angular.isArray(e.answer.selection)?e.answer.selection.forEach(function(e){r.push(e)}):r=[e.answer.selection],n=r.indexOf(e.otherOption.value),-1!==n&&("undefined"==typeof e.answer.otherValue?r.splice(n,1):r[n]=e.answer.otherValue)),"First Form"===e.response.question.type)1===r.length&&(o.answer=r[0],a.push(o));else if("Second Form Subject"===e.response.question.type){var i=r;i.forEach(function(e){o.subject=e,a.push(angular.copy(o))})}else{var l=[];switch(e.response.question.dataType){case"date":case"number":l=e.response.question.plural?r:"undefined"!=typeof e.answer.value?[e.answer.value]:[];break;default:l=r}l.forEach(function(n){o.object="date"===e.response.question.dataType?n.getTime?n.getTime():new Date(n).getTime():n,a.push(angular.copy(o))})}e.response.question.knownAnswers&&(e.response.question.plural||0===a.length)&&e.response.question.knownAnswers.forEach(function(e){var n=e;n.relationship=n.relationship.name,a.push(n)}),0===a.length&&(o.unanswered=!0,a.push(o)),e.postMessage({id:t.id,sessionId:m,answers:a}),s.response({id:t.id,sessionId:m,answers:a},function(n){e.processResponse(n)},function(e){c(e.data)})},e.done=function(){e.postMessage("Done"),$("#tryGoalModal").modal("hide")},e.datePicker=function(){var e={};return e.instances=[],e.open=function(n,t){n.preventDefault(),n.stopPropagation(),e.instances[t]=!e.instances[t]},e.options={startingDay:1,showWeeks:!1},e}(),e.exit=function(){e.postMessage("Reset"),i.go("goalList")},e.conceptIsKnownAnswer=function(n){var t=!1;return e.response.question.knownAnswers.forEach(function(o){(n===o.subject&&"Second Form Subject"===e.response.question.type||n===o.object&&"Second Form Object"===e.response.question.type)&&(t=!0)}),t},e.displayContinueOrSkip=function(){return!e.response.question.allowUnknown||e.answer.selection&&g(e.answer.selection)||h(e.answer.value)?"Continue":"Skip"},e.disableContinue=function(){return!(e.response.question.allowUnknown||h(e.answer.value)||!(e.response.question.knownAnswers&&0==e.response.question.knownAnswers.length||void 0==e.response.question.knownAnswers)||e.answer.selection&&g(e.answer.selection))},y()}]);
angular.module("rbAgent").controller("AgentGoalListController",["agentMemory","$scope","$rootScope","config","$state",function(o,e,n,t,l){function s(o,e,n){console.log("------- Rainbird Agent -------"),console.log("Agent ID   :",o),console.log("Endpoint   :",e),console.log("User       :",n.kbUser),console.log("Goals      :",n.goals.length),console.log("Evidence   :",n.showEvidence?"enabled":"disabled"),console.log("Context    :",n.showAlias?"enabled":"disabled"),console.log("UI-Settings:",n.uiSettings),console.log("------------------------------")}function a(o){e.errorMessage=o.message?o.message:"Sorry! An error occurred. Please try again.",e.display="error"}e.config=t,e.contextId=o.contextId,void 0===t.$resolved||t.$resolved?s(e.id,e.api,t):t.$promise.then(function(){s(e.id,e.api,t)}).catch(function(o){a(o.data)}),e.startGoal=function(n){parent.postMessage({goal:n},"*"),n.contextId=e.contextId,o.contextId=n.contextId,l.go("startGoal",{goalInfo:n,id:e.id})}}]);