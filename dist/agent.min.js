function resourceErrorHandler(r){console.log("Resource Error"),console.log(r)}var services=angular.module("rbApp.tryGoal.service",["ngResource"]);services.factory("ConfigAPI",["$resource",function(r){return r("",{},{config:{method:"GET",url:"/agent/:id/config",interceptor:{responseError:resourceErrorHandler}},getGoalInfo:{method:"GET",url:"/goal/info/:goalid/:id",interceptor:{responseError:resourceErrorHandler}},getSessionId:{method:"GET",url:"/agent/:id/start/contextid",interceptor:{responseError:resourceErrorHandler}}})}]),services.factory("agentHttpInterceptor",["agentMemory","$rootScope",function(r,e){return e.apiOutput=new Array,{request:function(o){if(r.tryGoal&&!o.url.endsWith(".html")&&(o.url.endsWith("query")||o.url.endsWith("response"))){var t={type:"request"};t.method=o.method,t.url=o.url,t.params=o.params,t.data=o.data,t.headers=o.headers,e.apiOutput.push(t)}return o},response:function(o){var t;return o.data&&o.data.apiLog?(t=o.data.apiLog,e.apiOutput.push(t.request),e.apiOutput.push(t.response)):r.tryGoal&&!o.config.url.endsWith(".html")&&(o.config.url.endsWith("query")||o.config.url.endsWith("response"))&&(t={type:"response"},t.method=o.config.method,t.url=o.config.url,t.data=o.data,t.headers=o.config.headers,e.apiOutput.push(t)),o}}}]),services.factory("GoalAPI",["$resource","ApiConfig",function(r,e){return r("",{sessionId:"@sessionId"},{startGoal:{method:"GET",url:e.getConfig().url+"/start/:id",interceptor:{responseError:resourceErrorHandler},headers:{Authorization:e.getConfig().auth}},queryGoal:{method:"POST",url:e.getConfig().url+"/:sessionId/query",interceptor:{responseError:resourceErrorHandler}},response:{method:"POST",url:e.getConfig().url+"/:sessionId/response",interceptor:{responseError:resourceErrorHandler}},back:{method:"POST",url:e.getConfig().url+"/:sessionId/undo",interceptor:{responseError:resourceErrorHandler}}})}]);
angular.module("rbApp.tryGoal",["rbApp.tryGoal.service","ng-showdown"]).config(["$showdownProvider",function(e){e.setOption("omitExtraWLInCodeBlocks",!0),e.setOption("literalMidWordUnderscores",!0),e.setOption("strikethrough",!0),e.setOption("tables",!0),e.setOption("ghCodeBlocks",!0),e.setOption("tasklists",!0),e.setOption("disableForced4SpacesIndentedSublists",!0),e.setOption("simpleLineBreaks",!0),e.setOption("noHeaderId",!0),e.setOption("parseImgDimensions",!0),e.setOption("openLinksInNewWindow",!0)}]);
var agentApp=angular.module("rbAgent",["ui.router","rbApp.tryGoal","rbApp.tryGoal.service","ui.bootstrap"]);agentApp.value("agentMemory",{contextId:"",sessionId:"",tryGoal:!1}),agentApp.config(["$stateProvider","$urlRouterProvider","$httpProvider",function(t,r,e){r.otherwise("/"),t.state("unauthorised",{url:"/unauthorised"}).state("goalList",{url:"/",templateUrl:"/applications/goalList/agentGoalList.html",controller:"AgentGoalListController",resolve:{config:["$q","ConfigAPI","$rootScope","Security","$state",function(t,r,e,o,n){var i=t.defer();return r.config({id:e.id}).$promise.then(function(t){o.checkReferrerValid(t.authorisedDomains)?i.resolve(t):(n.go("unauthorised"),i.reject())}),i.promise}]}}).state("startGoal",{url:"/startGoal",templateUrl:"/applications/tryGoal/component/tryGoalAgent.html",controller:"TryGoalController",resolve:{config:["ConfigAPI","$rootScope",function(t,r){return t.config({id:r.id})}]},params:{goalInfo:null,id:null}}),e.interceptors.push("agentHttpInterceptor")}]),agentApp.service("ApiConfig",["$rootScope",function(t){var r={url:t.api};return{getConfig:function(){return r}}}]),agentApp.factory("focusElementById",["$timeout","$window",function(t,r){return function(e){t(function(){var t=r.document.getElementById(e);t&&t.focus()})}}]),agentApp.factory("Security",["$window","formatHelpers",function(t,r){return{checkReferrerValid:function(e){var o=!0;if(t.self!=t.top){var n=t.document.referrer;if(Array.isArray(e)&&e.length>0&&n){var i=r.formatAuthorisedDomain(e),a=r.extractSchemeAndHost(n),u=i.indexOf(a);-1===u&&(o=!1)}}return o}}}]),agentApp.factory("formatHelpers",function(){var t={};return t.extractSchemeAndHost=function(t){var r=t.match(/(^https?\:\/\/([^\/?#]+))(?:[\/?#]|$)/i);return r&&r[1]},t.formatAuthorisedDomain=function(r){var e=[];return r.forEach(function(r){e.push(t.extractSchemeAndHost(r))}),e},t}),agentApp.directive("autofocus",["$timeout",function(t){return{restrict:"A",link:function(r,e){t(function(){e[0].focus()},500)}}}]);
angular.module("rbApp.tryGoal").controller("TryGoalController",["$scope","agentMemory","$compile","$stateParams","config","GoalAPI","ConfigAPI","ApiConfig","$state","$location","$filter","focusElementById","$timeout","$rootScope",function(e,n,t,o,s,a,r,i,l,u,c,p,d,f){function g(n){e.errorMessage=n&&n.message?n.message:"Unfortunately Rainbird has been unable to process the goal against the current Knowledge Map.",e.display="error"}function h(e){return'<input id="numberInput'+e+'" class="rb-try-goal-full-width numberInput" rb-number-only type="number" ng-model="answer.selection['+e+']" class="rb_input number" />'}function b(e){return'<div class="instanceDatepicker" id="dateInput'+e+'"><input id="dateInputText'+e+'" type="text" class="form-control" uib-datepicker-popup ng-model="answer.selection['+e+']" is-open="datePicker.instances['+e+']" datepicker-options="datePicker.options" ng-required="true" close-text="Close" show-button-bar="false" placeholder="yyyy-MM-dd" popup-placement="auto bottom-left" ng-model-options="{timezone: \'utc\'}"/>  <button id="datePicker'+e+'" type="button" class="btn btn-default displayPicker" ng-click="datePicker.open($event, '+e+')"><i class="glyphicon glyphicon-calendar"></i></button></div>'}function y(e){"date"===e.question.objectType&&(e.question.prompt=e.question.prompt.replace(e.question.object,c("rbDateOutputFormat")(e.question.object)))}function I(n){return n&&n.prompt===e.response.question.prompt&&n.type===e.response.question.type}function m(e){for(var n=0;n<e.length;n++)if(w(e[n]))return!0;return!1}function w(e){return e||0===e||e===!1}function q(){null!=o.goalInfo?(e.display="thinking",e.goalInfo=o.goalInfo,e.runGoal(e.goalInfo)):l.go("goalList")}function v(){o.hasOwnProperty("goalInfo")&&q()}var j,k;e.config=s,e.otherOption={value:"(other - not listed)"},e.yolandaUrl=i.getConfig().url,e.tryGoal=n.tryGoal,e.splitScreen=!1,e.updateAlias=function(){k=null},e.$on("tryGoal",function(n,t){$("#tryGoalModal").modal("show"),e.display="thinking",r.getGoalInfo({goalid:t.goalid,id:o.id},function(n){e.goalInfo=n,e.runGoal(n)})}),e.getGoalInfo=function(n){e.display="thinking",r.getGoalInfo({goalid:n,id:o.id},function(n){e.goalInfo=n,e.runGoal(n)})},e.postMessage=function(e){parent.postMessage(e,"*")},e.runGoal=function(n){var t=!1;e.init={},f.apiOutput=new Array,j=n.contextId,"user provided"===n.objectInstance?(e.objectPrompt=n.object,e.subjectPrompt=null,t=!0):"user provided"===n.subjectInstance?(e.subjectPrompt=n.subject,e.objectPrompt=null,t=!0):(e.init.subjectInstance=n.subjectInstance,e.init.objectInstance=n.objectInstance),t?e.display="init data":e.startGoalContext()},e.$watch("apiOutput",function(){if(n.tryGoal){var e=JSON.stringify(f.apiOutput,null,1),t=e.split("\n");t.splice(0,1),t.length>0&&t.splice(t.length-1,1),f.apiOutputDisplay=t.join("\n")}d(function(){var e=document.querySelector("#scroll-content");e.scrollTop=e.scrollHeight},150)},!0),e.addPluralInput=function(n){var o=e.pluralInputCounter++,s=angular.element("number"==n?h(o):b(o)),a=document.querySelector("#"+n+"Inputs");t(s)(e),angular.element(a).append(s)},e.removePluralInput=function(n){var t=document.querySelector("#"+n+"Input"+(e.pluralInputCounter-1));t.parentNode.removeChild(t),delete e.answer.selection[e.pluralInputCounter-1],e.pluralInputCounter--},e.startGoalContext=function(){e.display="thinking",r.getSessionId({id:o.id,contextid:j},function(n){k=n.sessionId,e.queryGoal()})},e.queryGoal=function(){var n={id:o.id,sessionId:k,object:"user provided"==e.goalInfo.objectInstance?e.init.objectInstance:e.goalInfo.objectInstance,subject:"user provided"==e.goalInfo.subjectInstance?e.init.subjectInstance:e.goalInfo.subjectInstance,relationship:e.goalInfo.relationship?e.goalInfo.relationship:e.goalInfo.rel};e.postMessage(n),a.queryGoal(n,function(n){e.showError=!1,e.processResponse(n)},function(e){g(e.data)})},e.processResponse=function(n){e.postMessage(n),n.question&&n.question.allowUnknown&&p("mainAgent"),e.answer={cf:100,selection:[]},e.otherValues=[],e.response=n,n.question?(n.question.plural&&(e.pluralInputCounter=1,e.answer.selection=[]),"First Form"===n.question.type?(e.display="firstForm",y(n)):(e.response.concepts=n.question.concepts,e.response.concepts&&n.question.canAdd!==!1&&!e.response.question.plural&&e.response.concepts.push(e.otherOption),e.display="secondForm")):n.result&&angular.isArray(n.result)&&n.result.length>0?(e.goalResults=[],n.result.forEach(function(n){var t=e.goalInfo.goalText?e.goalInfo.goalText:e.goalInfo.text,o=n.objectMetadata?n.objectMetadata:"";t=t.replace("%O",n.object),t=t.replace("%R",n.relationship),t=t.replace("%S",n.subject),e.goalResults.push(e.config.showEvidence?{text:t,cf:n.certainty,meta:o,factID:n.factID}:{text:t,cf:n.certainty,meta:o})}),e.display="result",p(e.tryGoal?"reset":"done")):angular.isArray(n.result)?e.display="end":g(n)},e.addOtherInput=function(){if(e.response.question.plural&&!~e.otherValues.indexOf("")){var n=e.otherValues.length,o=e.response.question.concepts?e.response.question.concepts.length:0;e.otherValues[n]="";var s=angular.element('<div class="inlineCheckboxGrouped" id="otherValueInput'+n+'"><label><i class="fa fa-minus-square" aria-hidden="true" ng-click="selectConcept(otherValues['+n+"], "+(n+o)+"); removeOtherInput("+n+')"></i><input ng-model="otherValues['+n+']" class="rb-try-goal-full-width"  placeholder="enter other value" ng-change="selectConcept(otherValues['+n+"], "+(n+o)+"); addOtherInput(["+n+'])"    value="" type="text" style="margin-left: 3px;"></label></div>');t(s)(e);var a=document.querySelector("#secondFormBlock");angular.element(a).append(s)}},e.removeOtherInput=function(n){void 0!==n&&(e.otherValues[n]="");for(var t=e.otherValues.indexOf(""),o=Object.keys(e.otherValues),s=o.length-1;s>=0;s--)void 0!=e.otherValues[o[s]]&&""!==e.otherValues[o[s]]||o[s]==t||(angular.element("#otherValueInput"+o[s]).remove(),delete e.otherValues[o[s]])},e.enterPressed=function(){"init data"===e.display?(e.init.objectInstance||e.init.subjectInstance)&&e.startGoalContext():e.disableContinue()||e.respond()},e.selectConcept=function(n,t){e.answer.selection[t]===n||""===n?delete e.answer.selection[t]:e.answer.selection[t]=n,e.removeOtherInput()},e.respond=function(){var n,t={subject:e.response.question.subject,relationship:e.response.question.relationship,object:e.response.question.object,cf:e.answer.cf},s=[],r=[];if(e.display="thinking",e.answer.selection&&(angular.isArray(e.answer.selection)?e.answer.selection.forEach(function(e){r.push(e)}):r=[e.answer.selection],n=r.indexOf(e.otherOption.value),-1!==n&&("undefined"==typeof e.answer.otherValue?r.splice(n,1):r[n]=e.answer.otherValue)),"First Form"===e.response.question.type)1===r.length&&(t.answer=r[0],s.push(t));else if("Second Form Subject"===e.response.question.type){var i=r;i.forEach(function(e){t.subject=e,s.push(angular.copy(t))})}else{var l=[];switch(e.response.question.dataType){case"date":case"number":l=e.response.question.plural?r:"undefined"!=typeof e.answer.value?[e.answer.value]:[];break;default:l=r}l.forEach(function(n){t.object="date"===e.response.question.dataType?n.getTime?n.getTime():new Date(n).getTime():n,s.push(angular.copy(t))})}e.response.question.knownAnswers&&(e.response.question.plural||0===s.length)&&e.response.question.knownAnswers.forEach(function(e){var n=e;n.relationship=n.relationship.name,s.push(n)}),0===s.length&&(t.unanswered=!0,s.push(t)),e.postMessage({id:o.id,sessionId:k,answers:s}),a.response({id:o.id,sessionId:k,answers:s},function(n){e.processResponse(n)},function(e){g(e.data)})},e.back=function(){e.display="thinking",a.back({sessionId:k},function(n){I(n.question)?e.runGoal(e.goalInfo):e.processResponse(n)},function(e){g(e.data)})},e.done=function(){e.postMessage("Done"),$("#tryGoalModal").modal("hide")},e.datePicker=function(){var e={};return e.instances=[],e.open=function(n,t){n.preventDefault(),n.stopPropagation(),e.instances[t]=!e.instances[t]},e.options={startingDay:1,showWeeks:!1},e}(),e.exit=function(){e.postMessage("Reset"),l.go("goalList")},e.conceptIsKnownAnswer=function(n){var t=!1;return e.response.question.knownAnswers.forEach(function(o){(n===o.subject&&"Second Form Subject"===e.response.question.type||n===o.object&&"Second Form Object"===e.response.question.type)&&(t=!0)}),t},e.displayContinueOrSkip=function(){return!e.response.question.allowUnknown||e.answer.selection&&m(e.answer.selection)||w(e.answer.value)?"Continue":"Skip"},e.disableContinue=function(){return!(e.response.question.allowUnknown||w(e.answer.value)||!(e.response.question.knownAnswers&&0==e.response.question.knownAnswers.length||void 0==e.response.question.knownAnswers)||e.answer.selection&&m(e.answer.selection))},v()}]);
angular.module("rbAgent").controller("AgentGoalListController",["agentMemory","$scope","$rootScope","config","$state",function(o,e,t,n,a){function l(o,e,t){console.log("------- Rainbird Agent -------"),console.log("Agent ID   :",o),console.log("Endpoint   :",e),console.log("User       :",t.kbUser),console.log("Goals      :",t.goals.length),console.log("Evidence   :",t.showEvidence?"enabled":"disabled"),console.log("Context    :",t.showAlias?"enabled":"disabled"),console.log("UI-Settings:",t.uiSettings),console.log("------------------------------")}function s(o){e.errorMessage=o.message?o.message:"Sorry! An error occurred. Please try again.",e.display="error"}e.config=n,e.contextId=o.contextId,e.tryGoal=!1,window.addEventListener("message",function(t){t.data&&t.data.tryGoal&&(o.tryGoal=!0,t.data.close?a.go("goalList"):(parent.postMessage("goal received","*"),a.go("startGoal",{goalInfo:t.data,id:e.id})))},!1),void 0===n.$resolved||n.$resolved?l(e.id,e.api,n):n.$promise.then(function(){l(e.id,e.api,n)}).catch(function(o){s(o.data)}),e.startGoal=function(t){parent.postMessage({goal:t},"*"),t.contextId=e.contextId,o.contextId=t.contextId,a.go("startGoal",{goalInfo:t,id:e.id})}}]);